import { AstroCheck, DiagnosticSeverity } from "@astrojs/language-server";
import { bold, black, bgWhite, red, cyan, yellow } from "kleur/colors";
import glob from "fast-glob";
import * as path from "path";
import { pathToFileURL } from "url";
import * as fs from "fs";
async function openAllDocuments(workspaceUri, filePathsToIgnore, checker) {
  const files = await glob("**/*.astro", {
    cwd: workspaceUri.pathname,
    ignore: ["node_modules/**"].concat(filePathsToIgnore.map((ignore) => `${ignore}/**`))
  });
  const absFilePaths = files.map((f) => path.resolve(workspaceUri.pathname, f));
  for (const absFilePath of absFilePaths) {
    const text = fs.readFileSync(absFilePath, "utf-8");
    checker.upsertDocument({
      uri: pathToFileURL(absFilePath).toString(),
      text
    });
  }
}
function offsetAt({ line, character }, text) {
  let i = 0;
  let l = 0;
  let c = 0;
  while (i < text.length) {
    if (l === line && c === character) {
      break;
    }
    let char = text[i];
    switch (char) {
      case "\n": {
        l++;
        c = 0;
        break;
      }
      default: {
        c++;
        break;
      }
    }
    i++;
  }
  return i;
}
function pad(str, len) {
  return Array.from({ length: len }, () => str).join("");
}
async function run() {
}
async function check(astroConfig) {
  const root = astroConfig.projectRoot;
  let checker = new AstroCheck(root.toString());
  await openAllDocuments(root, [], checker);
  let diagnostics = await checker.getDiagnostics();
  let result = {
    errors: 0,
    warnings: 0
  };
  diagnostics.forEach((diag) => {
    diag.diagnostics.forEach((d) => {
      switch (d.severity) {
        case DiagnosticSeverity.Error: {
          console.error(`${bold(cyan(path.relative(root.pathname, diag.filePath)))}:${bold(yellow(d.range.start.line))}:${bold(yellow(d.range.start.character))} - ${d.message}`);
          let startOffset = offsetAt({ line: d.range.start.line, character: 0 }, diag.text);
          let endOffset = offsetAt({ line: d.range.start.line + 1, character: 0 }, diag.text);
          let str = diag.text.substring(startOffset, endOffset - 1);
          const lineNumStr = d.range.start.line.toString();
          const lineNumLen = lineNumStr.length;
          console.error(`${bgWhite(black(lineNumStr))}  ${str}`);
          let tildes = pad("~", d.range.end.character - d.range.start.character);
          let spaces = pad(" ", d.range.start.character + lineNumLen - 1);
          console.error(`   ${spaces}${bold(red(tildes))}
`);
          result.errors++;
          break;
        }
        case DiagnosticSeverity.Warning: {
          result.warnings++;
          break;
        }
      }
    });
  });
  if (result.errors) {
    console.error(`Found ${result.errors} errors.`);
  }
  const exitCode = result.errors ? 1 : 0;
  return exitCode;
}
export {
  check,
  run
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vc3JjL2NsaS9jaGVjay50cyJdLAogICJtYXBwaW5ncyI6ICJBQUNBO0FBR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBLGdDQUFnQyxjQUFtQixtQkFBNkIsU0FBcUI7QUFDbkcsUUFBTSxRQUFRLE1BQU0sS0FBSyxjQUFjO0FBQUEsSUFDckMsS0FBSyxhQUFhO0FBQUEsSUFDbEIsUUFBUSxDQUFDLG1CQUFtQixPQUFPLGtCQUFrQixJQUFJLENBQUMsV0FBVyxHQUFHO0FBQUE7QUFFMUUsUUFBTSxlQUFlLE1BQU0sSUFBSSxDQUFDLE1BQU0sS0FBSyxRQUFRLGFBQWEsVUFBVTtBQUUxRSxhQUFXLGVBQWUsY0FBYztBQUN0QyxVQUFNLE9BQU8sR0FBRyxhQUFhLGFBQWE7QUFDMUMsWUFBUSxlQUFlO0FBQUEsTUFDckIsS0FBSyxjQUFjLGFBQWE7QUFBQSxNQUNoQztBQUFBO0FBQUE7QUFBQTtBQVVOLGtCQUFrQixFQUFFLE1BQU0sYUFBa0QsTUFBYztBQUN4RixNQUFJLElBQUk7QUFDUixNQUFJLElBQUk7QUFDUixNQUFJLElBQUk7QUFDUixTQUFPLElBQUksS0FBSyxRQUFRO0FBQ3RCLFFBQUksTUFBTSxRQUFRLE1BQU0sV0FBVztBQUNqQztBQUFBO0FBR0YsUUFBSSxPQUFPLEtBQUs7QUFDaEIsWUFBUTtBQUFBLFdBQ0QsTUFBTTtBQUNUO0FBQ0EsWUFBSTtBQUNKO0FBQUE7QUFBQSxlQUVPO0FBQ1A7QUFDQTtBQUFBO0FBQUE7QUFJSjtBQUFBO0FBR0YsU0FBTztBQUFBO0FBR1QsYUFBYSxLQUFhLEtBQWE7QUFDckMsU0FBTyxNQUFNLEtBQUssRUFBRSxRQUFRLE9BQU8sTUFBTSxLQUFLLEtBQUs7QUFBQTtBQUdyRCxxQkFBNEI7QUFBQTtBQUU1QixxQkFBNEIsYUFBMEI7QUFDcEQsUUFBTSxPQUFPLFlBQVk7QUFDekIsTUFBSSxVQUFVLElBQUksV0FBVyxLQUFLO0FBQ2xDLFFBQU0saUJBQWlCLE1BQU0sSUFBSTtBQUVqQyxNQUFJLGNBQWMsTUFBTSxRQUFRO0FBRWhDLE1BQUksU0FBaUI7QUFBQSxJQUNuQixRQUFRO0FBQUEsSUFDUixVQUFVO0FBQUE7QUFHWixjQUFZLFFBQVEsQ0FBQyxTQUFTO0FBQzVCLFNBQUssWUFBWSxRQUFRLENBQUMsTUFBTTtBQUM5QixjQUFRLEVBQUU7QUFBQSxhQUNILG1CQUFtQixPQUFPO0FBQzdCLGtCQUFRLE1BQU0sR0FBRyxLQUFLLEtBQUssS0FBSyxTQUFTLEtBQUssVUFBVSxLQUFLLGVBQWUsS0FBSyxPQUFPLEVBQUUsTUFBTSxNQUFNLFVBQVUsS0FBSyxPQUFPLEVBQUUsTUFBTSxNQUFNLGlCQUFpQixFQUFFO0FBQzdKLGNBQUksY0FBYyxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sTUFBTSxNQUFNLFdBQVcsS0FBSyxLQUFLO0FBQzVFLGNBQUksWUFBWSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sTUFBTSxPQUFPLEdBQUcsV0FBVyxLQUFLLEtBQUs7QUFDOUUsY0FBSSxNQUFNLEtBQUssS0FBSyxVQUFVLGFBQWEsWUFBWTtBQUN2RCxnQkFBTSxhQUFhLEVBQUUsTUFBTSxNQUFNLEtBQUs7QUFDdEMsZ0JBQU0sYUFBYSxXQUFXO0FBQzlCLGtCQUFRLE1BQU0sR0FBRyxRQUFRLE1BQU0saUJBQWlCO0FBQ2hELGNBQUksU0FBUyxJQUFJLEtBQUssRUFBRSxNQUFNLElBQUksWUFBWSxFQUFFLE1BQU0sTUFBTTtBQUM1RCxjQUFJLFNBQVMsSUFBSSxLQUFLLEVBQUUsTUFBTSxNQUFNLFlBQVksYUFBYTtBQUM3RCxrQkFBUSxNQUFNLE1BQU0sU0FBUyxLQUFLLElBQUk7QUFBQTtBQUN0QyxpQkFBTztBQUNQO0FBQUE7QUFBQSxhQUVHLG1CQUFtQixTQUFTO0FBQy9CLGlCQUFPO0FBQ1A7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQU1SLE1BQUksT0FBTyxRQUFRO0FBQ2pCLFlBQVEsTUFBTSxTQUFTLE9BQU87QUFBQTtBQUdoQyxRQUFNLFdBQVcsT0FBTyxTQUFTLElBQUk7QUFDckMsU0FBTztBQUFBOyIsCiAgIm5hbWVzIjogW10KfQo=
