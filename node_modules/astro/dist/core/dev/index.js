import path from "path";
import { fileURLToPath } from "url";
import { promisify } from "util";
import connect from "connect";
import mime from "mime";
import { polyfill } from "@astropub/webapi";
import { performance } from "perf_hooks";
import stripAnsi from "strip-ansi";
import vite from "../vite.js";
import { defaultLogOptions, error, info } from "../logger.js";
import { ssr } from "../ssr/index.js";
import { STYLE_EXTENSIONS } from "../ssr/css.js";
import { collectResources } from "../ssr/html.js";
import { createRouteManifest, matchRoute } from "../ssr/routing.js";
import { createVite } from "../create-vite.js";
import * as msg from "./messages.js";
import notFoundTemplate, { subpathNotUsedTemplate } from "./template/4xx.js";
import serverErrorTemplate from "./template/5xx.js";
async function dev(config, options = { logging: defaultLogOptions }) {
  polyfill(globalThis);
  const server = new AstroDevServer(config, options);
  await server.start();
  process.on("SIGTERM", () => server.stop());
  return {
    hostname: server.hostname,
    port: server.port,
    server: server.app,
    stop: () => server.stop()
  };
}
class AstroDevServer {
  constructor(config, options) {
    this.app = connect();
    this.routeCache = {};
    this.config = config;
    this.hostname = config.devOptions.hostname || "localhost";
    this.logging = options.logging;
    this.port = config.devOptions.port;
    this.origin = `http://localhost:${this.port}`;
    this.site = config.buildOptions.site ? new URL(config.buildOptions.site) : void 0;
    this.devRoot = this.site ? this.site.pathname : "/";
    this.url = new URL(this.devRoot, this.origin);
    this.manifest = createRouteManifest({ config }, this.logging);
  }
  async start() {
    const devStart = performance.now();
    this.viteServer = await this.createViteServer();
    this.app.use(this.viteServer.middlewares);
    this.app.use((req, res, next) => this.handleRequest(req, res, next));
    this.app.use((req, res, next) => this.renderError(req, res, next));
    await this.listen(devStart);
  }
  async stop() {
    if (this.viteServer) {
      await this.viteServer.close();
    }
    if (this.httpServer) {
      await promisify(this.httpServer.close.bind(this.httpServer))();
    }
  }
  async handleHotUpdate({ file, modules }) {
    var _a;
    const { viteServer } = this;
    if (!viteServer)
      throw new Error(`AstroDevServer.start() not called`);
    for (const module of modules) {
      viteServer.moduleGraph.invalidateModule(module);
    }
    const route = this.mostRecentRoute;
    const [pathname, search = void 0] = ((_a = route == null ? void 0 : route.pathname) != null ? _a : "/").split("?");
    if (!route) {
      viteServer.ws.send({
        type: "full-reload"
      });
      return [];
    }
    try {
      const filePath = new URL(`./${route.component}`, this.config.projectRoot);
      const html = await ssr({
        astroConfig: this.config,
        filePath,
        logging: this.logging,
        mode: "development",
        origin: this.origin,
        pathname,
        route,
        routeCache: this.routeCache,
        viteServer
      });
      let invalidatedModules = [];
      await Promise.all(collectResources(html).filter(({ href }) => {
        if (!href)
          return false;
        const ext = path.extname(href);
        return STYLE_EXTENSIONS.has(ext);
      }).map(async ({ href }) => {
        const viteModule = viteServer.moduleGraph.getModuleById(`${href}?direct`) || await viteServer.moduleGraph.getModuleByUrl(`${href}?direct`) || viteServer.moduleGraph.getModuleById(href) || await viteServer.moduleGraph.getModuleByUrl(href);
        if (viteModule) {
          invalidatedModules.push(viteModule);
          viteServer.moduleGraph.invalidateModule(viteModule);
        }
      }));
      viteServer.ws.send({
        type: "custom",
        event: "astro:reload",
        data: { html }
      });
      for (const viteModule of invalidatedModules) {
        setTimeout(() => {
          viteServer.ws.send({
            type: "update",
            updates: [
              {
                type: viteModule.type === "js" ? "js-update" : "css-update",
                path: viteModule.id || viteModule.file || viteModule.url,
                acceptedPath: viteModule.url,
                timestamp: Date.now()
              }
            ]
          });
        }, 150);
      }
      return [];
    } catch (e) {
      const err = e;
      console.error(err.stack);
      viteServer.ws.send({
        type: "full-reload"
      });
      return [];
    }
  }
  listen(devStart) {
    let showedPortTakenMsg = false;
    return new Promise((resolve, reject) => {
      const listen = () => {
        var _a;
        this.httpServer = this.app.listen(this.port, this.hostname, () => {
          info(this.logging, "astro", msg.devStart({ startupTime: performance.now() - devStart }));
          info(this.logging, "astro", msg.devHost({ host: `http://${this.hostname}:${this.port}${this.devRoot}` }));
          resolve();
        });
        (_a = this.httpServer) == null ? void 0 : _a.on("error", onError);
      };
      const onError = (err) => {
        var _a;
        if (err.code && err.code === "EADDRINUSE") {
          if (!showedPortTakenMsg) {
            info(this.logging, "astro", msg.portInUse({ port: this.port }));
            showedPortTakenMsg = true;
          }
          this.port++;
          return listen();
        } else {
          error(this.logging, "astro", err.stack);
          (_a = this.httpServer) == null ? void 0 : _a.removeListener("error", onError);
          reject(err);
        }
      };
      listen();
    });
  }
  async createViteServer() {
    const viteConfig = await createVite(vite.mergeConfig({
      mode: "development",
      server: {
        middlewareMode: "ssr",
        host: this.hostname
      }
    }, this.config.vite || {}), { astroConfig: this.config, logging: this.logging, devServer: this });
    const viteServer = await vite.createServer(viteConfig);
    const pagesDirectory = fileURLToPath(this.config.pages);
    viteServer.watcher.on("add", (file) => {
      if (!file.startsWith(pagesDirectory)) {
        return;
      }
      this.routeCache = {};
      this.manifest = createRouteManifest({ config: this.config }, this.logging);
    });
    viteServer.watcher.on("unlink", (file) => {
      if (!file.startsWith(pagesDirectory)) {
        return;
      }
      this.routeCache = {};
      this.manifest = createRouteManifest({ config: this.config }, this.logging);
    });
    viteServer.watcher.on("change", () => {
      this.routeCache = {};
    });
    return viteServer;
  }
  async handleRequest(req, res, next) {
    if (!this.viteServer)
      throw new Error(`AstroDevServer.start() not called`);
    let [pathname, search = void 0] = (req.url || "/").split("?");
    const reqStart = performance.now();
    let filePath;
    try {
      let routePathname = pathname;
      if (this.devRoot !== "/") {
        if (pathname.startsWith(this.devRoot)) {
          routePathname = pathname.substr(this.devRoot.length) || "";
          if (!routePathname.startsWith("/")) {
            routePathname = "/" + routePathname;
          }
        } else {
          next();
          return;
        }
      }
      const route = matchRoute(routePathname, this.manifest);
      if (!route) {
        const newPathname = routePathname.startsWith("/") ? routePathname : "/" + routePathname;
        req.url = newPathname;
        next();
        return;
      }
      filePath = new URL(`./${route.component}`, this.config.projectRoot);
      const html = await ssr({
        astroConfig: this.config,
        filePath,
        logging: this.logging,
        mode: "development",
        origin: this.origin,
        pathname,
        route,
        routeCache: this.routeCache,
        viteServer: this.viteServer
      });
      this.mostRecentRoute = route;
      info(this.logging, "astro", msg.req({ url: pathname, statusCode: 200, reqTime: performance.now() - reqStart }));
      res.writeHead(200, {
        "Content-Type": mime.getType(".html"),
        "Content-Length": Buffer.byteLength(html, "utf8")
      });
      res.write(html);
      res.end();
    } catch (err) {
      const statusCode = 500;
      await this.viteServer.moduleGraph.invalidateAll();
      this.viteServer.ws.send({ type: "error", err });
      let html = serverErrorTemplate({
        statusCode,
        title: "Internal Error",
        tabTitle: "500: Error",
        message: stripAnsi(err.message),
        url: err.url || void 0,
        stack: stripAnsi(err.stack)
      });
      html = await this.viteServer.transformIndexHtml(pathname, html, pathname);
      info(this.logging, "astro", msg.req({ url: pathname, statusCode: 500, reqTime: performance.now() - reqStart }));
      res.writeHead(statusCode, {
        "Content-Type": mime.getType(".html"),
        "Content-Length": Buffer.byteLength(html, "utf8")
      });
      res.write(html);
      res.end();
    }
  }
  async renderError(req, res, next) {
    if (!this.viteServer)
      throw new Error(`AstroDevServer.start() not called`);
    const pathname = req.url || "/";
    const reqStart = performance.now();
    let html = "";
    const statusCode = 404;
    const relPages = this.config.pages.href.replace(this.config.projectRoot.href, "");
    const userDefined404 = this.manifest.routes.find((route) => route.component === relPages + "404.astro");
    if (userDefined404) {
      html = await ssr({
        astroConfig: this.config,
        filePath: new URL(`./${userDefined404.component}`, this.config.projectRoot),
        logging: this.logging,
        mode: "development",
        pathname: `/${userDefined404.component}`,
        origin: this.origin,
        routeCache: this.routeCache,
        viteServer: this.viteServer
      });
    } else {
      if (pathname === "/" && !pathname.startsWith(this.devRoot)) {
        html = subpathNotUsedTemplate(this.devRoot, pathname);
      } else {
        html = notFoundTemplate({ statusCode, title: "Not found", tabTitle: "404: Not Found", pathname });
      }
    }
    info(this.logging, "astro", msg.req({ url: pathname, statusCode, reqTime: performance.now() - reqStart }));
    res.writeHead(statusCode, {
      "Content-Type": mime.getType(".html"),
      "Content-Length": Buffer.byteLength(html, "utf8")
    });
    res.write(html);
    res.end();
  }
}
export {
  AstroDevServer,
  dev as default
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2NvcmUvZGV2L2luZGV4LnRzIl0sCiAgIm1hcHBpbmdzIjogIkFBTUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBY0EsbUJBQWtDLFFBQXFCLFVBQXNCLEVBQUUsU0FBUyxxQkFBeUM7QUFFL0gsV0FBUztBQUdULFFBQU0sU0FBUyxJQUFJLGVBQWUsUUFBUTtBQUMxQyxRQUFNLE9BQU87QUFHYixVQUFRLEdBQUcsV0FBVyxNQUFNLE9BQU87QUFDbkMsU0FBTztBQUFBLElBQ0wsVUFBVSxPQUFPO0FBQUEsSUFDakIsTUFBTSxPQUFPO0FBQUEsSUFDYixRQUFRLE9BQU87QUFBQSxJQUNmLE1BQU0sTUFBTSxPQUFPO0FBQUE7QUFBQTtBQUtoQixxQkFBcUI7QUFBQSxFQWdCMUIsWUFBWSxRQUFxQixTQUFxQjtBQWZ0RCxlQUFNO0FBWUUsc0JBQXlCO0FBSS9CLFNBQUssU0FBUztBQUNkLFNBQUssV0FBVyxPQUFPLFdBQVcsWUFBWTtBQUM5QyxTQUFLLFVBQVUsUUFBUTtBQUN2QixTQUFLLE9BQU8sT0FBTyxXQUFXO0FBQzlCLFNBQUssU0FBUyxvQkFBb0IsS0FBSztBQUN2QyxTQUFLLE9BQU8sT0FBTyxhQUFhLE9BQU8sSUFBSSxJQUFJLE9BQU8sYUFBYSxRQUFRO0FBQzNFLFNBQUssVUFBVSxLQUFLLE9BQU8sS0FBSyxLQUFLLFdBQVc7QUFDaEQsU0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLFNBQVMsS0FBSztBQUN0QyxTQUFLLFdBQVcsb0JBQW9CLEVBQUUsVUFBVSxLQUFLO0FBQUE7QUFBQSxRQUdqRCxRQUFRO0FBQ1osVUFBTSxXQUFXLFlBQVk7QUFHN0IsU0FBSyxhQUFhLE1BQU0sS0FBSztBQUM3QixTQUFLLElBQUksSUFBSSxLQUFLLFdBQVc7QUFDN0IsU0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLEtB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
